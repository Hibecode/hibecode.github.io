<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live ECG Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>ðŸ“ˆ Real-Time ECG Signal</h2>
  <div id="ecg-plot" style="width:100%;height:500px;"></div>

  <script>
    // === Ubidots MQTT WebSocket config ===
    const UBIDOTS_TOKEN = "BBUS-ZGjQBOrb7CD0wdMYkDxpoS5RtnAPdv";  // replace with your token
    const DEVICE_LABEL = "esp32";
    const VARIABLE_LABEL = "sensor";

    // Connect to Ubidots MQTT over WebSockets
    const client = mqtt.connect("wss://industrial.api.ubidots.com/mqtt", {
      username: UBIDOTS_TOKEN,  // token goes here
      password: UBIDOTS_TOKEN              // password left blank
    });

    client.on("connect", () => {
      console.log("âœ… Connected to Ubidots MQTT");
      const topic = `/v1.6/devices/${DEVICE_LABEL}/${VARIABLE_LABEL}/lv`;
      client.subscribe(topic, err => {
        if (!err) console.log("ðŸ“¡ Subscribed to:", topic);
      });
    });

    // Initialize empty ECG trace
    let ecgData = {
      x: [],
      y: [],
      type: "scatter",
      mode: "lines",
      line: {color: "red"}
    };

    Plotly.newPlot("ecg-plot", [ecgData], {
      margin: { t: 20 },
      xaxis: { title: "Samples" },
      yaxis: { title: "ECG (mV)" }
    });

    let counter = 0;
    const MAX_POINTS = 500; // limit to avoid lag

    // Handle incoming messages
    client.on("message", (topic, message) => {
      const value = parseFloat(message.toString());
      console.log("ECG:", value);

      ecgData.x.push(counter++);
      ecgData.y.push(value);

      if (ecgData.x.length > MAX_POINTS) {
        ecgData.x.shift();
        ecgData.y.shift();
      }

      Plotly.update("ecg-plot", {
        x: [ecgData.x],
        y: [ecgData.y]
      });
    });
  </script>
</body>
</html>
